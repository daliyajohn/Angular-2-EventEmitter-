"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var autoprefixer = require("autoprefixer");
var cssnano = require("cssnano");
var gulp = require("gulp");
var gulpLoadPlugins = require("gulp-load-plugins");
var merge = require("merge-stream");
var util = require("gulp-util");
var filter = require("gulp-filter");
var path_1 = require("path");
var config_1 = require("../../config");
var css_task_1 = require("../css_task");
var plugins = gulpLoadPlugins();
var gulpConcatCssConfig = config_1.default.getPluginConfig('gulp-concat-css');
var processors = [
    autoprefixer({
        browsers: config_1.default.BROWSER_LIST
    })
];
var reportPostCssError = function (e) { return util.log(util.colors.red(e.message)); };
var isProd = config_1.default.BUILD_TYPE === 'prod';
if (isProd) {
    processors.push(cssnano({
        discardComments: { removeAll: true },
        discardUnused: false,
        zindex: false,
        reduceIdents: false
    }));
}
var appSCSSFiles = path_1.join(config_1.default.APP_SRC, '**', '*.scss');
var entrySCSSFiles = path_1.join(config_1.default.CSS_SRC, '**', '*.scss');
var abstractSCSSFiles = path_1.join(config_1.default.SCSS_SRC, '**', '*.scss');
function prepareTemplates() {
    return gulp.src(path_1.join(config_1.default.APP_SRC, '**', '*.html'))
        .pipe(gulp.dest(config_1.default.TMP_DIR));
}
function processComponentStylesheets() {
    return config_1.default.ENABLE_SCSS ?
        merge(processComponentScss(), processComponentCss())
        :
            processComponentCss();
}
function processComponentScss() {
    return getSCSSFiles('process-component-scss', [appSCSSFiles], [abstractSCSSFiles])
        .pipe(plugins.sourcemaps.init())
        .pipe(plugins.sass(config_1.default.getPluginConfig('gulp-sass')).on('error', plugins.sass.logError))
        .pipe(plugins.postcss(processors))
        .on('error', reportPostCssError)
        .pipe(plugins.sourcemaps.write(isProd ? '.' : '', {
        sourceMappingURL: function (file) {
            return "" + config_1.default.APP_BASE + file.relative + ".map";
        }
    }))
        .pipe(gulp.dest(isProd ? config_1.default.TMP_DIR : config_1.default.APP_DEST));
}
function getSCSSFiles(cacheName, filesToCompile, filesToExclude) {
    if (filesToExclude === void 0) { filesToExclude = []; }
    var allFiles = filesToCompile.concat(filesToExclude);
    var filteredFiles = filesToCompile.concat(filesToExclude.map(function (path) { return '!' + path; }));
    return gulp.src(allFiles)
        .pipe(plugins.cached(cacheName))
        .pipe(plugins.progeny())
        .pipe(filter(filteredFiles));
}
function processComponentCss() {
    return gulp.src([
        path_1.join(config_1.default.APP_SRC, '**', '*.css'),
        '!' + path_1.join(config_1.default.APP_SRC, 'assets', '**', '*.css')
    ])
        .pipe(isProd ? plugins.cached('process-component-css') : plugins.util.noop())
        .pipe(plugins.postcss(processors))
        .on('error', reportPostCssError)
        .pipe(gulp.dest(isProd ? config_1.default.TMP_DIR : config_1.default.APP_DEST));
}
function processExternalStylesheets() {
    return config_1.default.ENABLE_SCSS ? processAllExternalStylesheets() : processExternalCss();
}
function processAllExternalStylesheets() {
    return merge(getExternalCssStream(), getExternalScssStream())
        .pipe(isProd ? plugins.concatCss(gulpConcatCssConfig.targetFile, gulpConcatCssConfig.options) : plugins.util.noop())
        .pipe(plugins.postcss(processors))
        .on('error', reportPostCssError)
        .pipe(gulp.dest(config_1.default.CSS_DEST));
}
function getExternalCssStream() {
    return gulp.src(getExternalCss())
        .pipe(isProd ? plugins.cached('process-external-css') : plugins.util.noop());
}
function getExternalCss() {
    return config_1.default.DEPENDENCIES.filter(function (dep) { return /\.css$/.test(dep.src); }).map(function (dep) { return dep.src; });
}
function getExternalScssStream() {
    return getSCSSFiles('process-external-scss', getExternalScss(), [abstractSCSSFiles])
        .pipe(plugins.sass(config_1.default.getPluginConfig('gulp-sass')).on('error', plugins.sass.logError));
}
function getExternalScss() {
    return config_1.default.DEPENDENCIES.filter(function (dep) { return /\.scss$/.test(dep.src); }).map(function (dep) { return dep.src; })
        .concat([entrySCSSFiles]);
}
function processExternalCss() {
    return getExternalCssStream()
        .pipe(plugins.postcss(processors))
        .pipe(isProd ? plugins.concatCss(gulpConcatCssConfig.targetFile, gulpConcatCssConfig.options) : plugins.util.noop())
        .on('error', reportPostCssError)
        .pipe(gulp.dest(config_1.default.CSS_DEST));
}
module.exports = (function (_super) {
    __extends(BuildHtmlCss, _super);
    function BuildHtmlCss() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    BuildHtmlCss.prototype.shallRun = function (files) {
        return _super.prototype.shallRun.call(this, files) || files.some(function (f) { return f.endsWith('.html'); });
    };
    BuildHtmlCss.prototype.run = function () {
        return merge(processComponentStylesheets(), prepareTemplates(), processExternalStylesheets());
    };
    return BuildHtmlCss;
}(css_task_1.CssTask));
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL21lZGlhL2RhbGl5YS9DMjcyRDdGRTcyRDdGNTVGL0dpdGh1YiBwcm9qZWN0cy9Bbmd1bGFyLTItRXZlbnRFbWl0dGVyLS90b29scy90YXNrcy9zZWVkL2J1aWxkLmh0bWxfY3NzLnRzIiwic291cmNlcyI6WyIvbWVkaWEvZGFsaXlhL0MyNzJEN0ZFNzJEN0Y1NUYvR2l0aHViIHByb2plY3RzL0FuZ3VsYXItMi1FdmVudEVtaXR0ZXItL3Rvb2xzL3Rhc2tzL3NlZWQvYnVpbGQuaHRtbF9jc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBNkM7QUFDN0MsaUNBQW1DO0FBQ25DLDJCQUE2QjtBQUM3QixtREFBcUQ7QUFDckQsb0NBQXNDO0FBQ3RDLGdDQUFrQztBQUNsQyxvQ0FBc0M7QUFDdEMsNkJBQTRCO0FBRTVCLHVDQUFrQztBQUNsQyx3Q0FBc0M7QUFFdEMsSUFBTSxPQUFPLEdBQVEsZUFBZSxFQUFFLENBQUM7QUFDdkMsSUFBTSxtQkFBbUIsR0FBRyxnQkFBTSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBRXRFLElBQU0sVUFBVSxHQUFHO0lBQ2pCLFlBQVksQ0FBQztRQUNYLFFBQVEsRUFBRSxnQkFBTSxDQUFDLFlBQVk7S0FDOUIsQ0FBQztDQUNILENBQUM7QUFFRixJQUFNLGtCQUFrQixHQUFHLFVBQUMsQ0FBTSxJQUFLLE9BQUEsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBcEMsQ0FBb0MsQ0FBQztBQUU1RSxJQUFNLE1BQU0sR0FBRyxnQkFBTSxDQUFDLFVBQVUsS0FBSyxNQUFNLENBQUM7QUFFNUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNYLFVBQVUsQ0FBQyxJQUFJLENBQ2IsT0FBTyxDQUFDO1FBQ04sZUFBZSxFQUFFLEVBQUMsU0FBUyxFQUFFLElBQUksRUFBQztR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QUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBRSxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ25ILEVBQUUsQ0FBQyxPQUFPLEVBQUUsa0JBQWtCLENBQUM7U0FDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLENBQUM7QUFLRDtJQUM2QixnQ0FBTztJQUFsQzs7SUFTQSxDQUFDO0lBUEMsK0JBQVEsR0FBUixVQUFTLEtBQWU7UUFDdEIsTUFBTSxDQUFDLGlCQUFNLFFBQVEsWUFBQyxLQUFLLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBbkIsQ0FBbUIsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCwwQkFBRyxHQUFIO1FBQ0UsTUFBTSxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxFQUFFLGdCQUFnQixFQUFFLEVBQUUsMEJBQTBCLEVBQUUsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUFURCxDQUEyQixrQkFBTyxHQVNoQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGF1dG9wcmVmaXhlciBmcm9tICdhdXRvcHJlZml4ZXInO1xuaW1wb3J0ICogYXMgY3NzbmFubyBmcm9tICdjc3NuYW5vJztcbmltcG9ydCAqIGFzIGd1bHAgZnJvbSAnZ3VscCc7XG5pbXBvcnQgKiBhcyBndWxwTG9hZFBsdWdpbnMgZnJvbSAnZ3VscC1sb2FkLXBsdWdpbnMnO1xuaW1wb3J0ICogYXMgbWVyZ2UgZnJvbSAnbWVyZ2Utc3RyZWFtJztcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAnZ3VscC11dGlsJztcbmltcG9ydCAqIGFzIGZpbHRlciBmcm9tICdndWxwLWZpbHRlcic7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5cbmltcG9ydCBDb25maWcgZnJvbSAnLi4vLi4vY29uZmlnJztcbmltcG9ydCB7IENzc1Rhc2sgfSBmcm9tICcuLi9jc3NfdGFzayc7XG5cbmNvbnN0IHBsdWdpbnMgPSA8YW55Pmd1bHBMb2FkUGx1Z2lucygpO1xuY29uc3QgZ3VscENvbmNhdENzc0NvbmZpZyA9IENvbmZpZy5nZXRQbHVnaW5Db25maWcoJ2d1bHAtY29uY2F0LWNzcycpO1xuXG5jb25zdCBwcm9jZXNzb3JzID0gW1xuICBhdXRvcHJlZml4ZXIoe1xuICAgIGJyb3dzZXJzOiBDb25maWcuQlJPV1NFUl9MSVNUXG4gIH0pXG5dO1xuXG5jb25zdCByZXBvcnRQb3N0Q3NzRXJyb3IgPSAoZTogYW55KSA9PiB1dGlsLmxvZyh1dGlsLmNvbG9ycy5yZWQoZS5tZXNzYWdlKSk7XG5cbmNvbnN0IGlzUHJvZCA9IENvbmZpZy5CVUlMRF9UWVBFID09PSAncHJvZCc7XG5cbmlmIChpc1Byb2QpIHtcbiAgcHJvY2Vzc29ycy5wdXNoKFxuICAgIGNzc25hbm8oe1xuICAgICAgZGlzY2FyZENvbW1lbnRzOiB7cmVtb3ZlQWxsOiB0cnVlfSxcbiAgICAgIGRpc2NhcmRVbnVzZWQ6IGZhbHNlLCAvLyB1bnNhZmUsIHNlZSBodHRwOi8vZ29vLmdsL1J0cnp3RlxuICAgICAgemluZGV4OiBmYWxzZSwgLy8gdW5zYWZlLCBzZWUgaHR0cDovL2dvby5nbC92WjRnYlFcbiAgICAgIHJlZHVjZUlkZW50czogZmFsc2UgLy8gdW5zYWZlLCBzZWUgaHR0cDovL2dvby5nbC90Tk9QdjBcbiAgICB9KVxuICApO1xufVxuXG5jb25zdCBhcHBTQ1NTRmlsZXMgICAgICA9IGpvaW4oQ29uZmlnLkFQUF9TUkMsICcqKicsICcqLnNjc3MnKTtcbmNvbnN0IGVudHJ5U0NTU0ZpbGVzICAgID0gam9pbihDb25maWcuQ1NTX1NSQywgJyoqJywgJyouc2NzcycpO1xuY29uc3QgYWJzdHJhY3RTQ1NTRmlsZXMgPSBqb2luKENvbmZpZy5TQ1NTX1NSQywgJyoqJywgJyouc2NzcycpO1xuXG4vKipcbiAqIENvcGllcyBhbGwgSFRNTCBmaWxlcyBpbiBgc3JjL2NsaWVudGAgb3ZlciB0byB0aGUgYGRpc3QvdG1wYCBkaXJlY3RvcnkuXG4gKi9cbmZ1bmN0aW9uIHByZXBhcmVUZW1wbGF0ZXMoKSB7XG4gIHJldHVybiBndWxwLnNyYyhqb2luKENvbmZpZy5BUFBfU1JDLCAnKionLCAnKi5odG1sJykpXG4gICAgLnBpcGUoZ3VscC5kZXN0KENvbmZpZy5UTVBfRElSKSk7XG59XG5cbi8qKlxuICogRXhlY3V0ZSB0aGUgYXBwcm9wcmlhdGUgY29tcG9uZW50LXN0eWxlc2hlZXQgcHJvY2Vzc2luZyBtZXRob2QgYmFzZWQgb24gdXNlciBzdHlsZXNoZWV0IHByZWZlcmVuY2UuXG4gKi9cbmZ1bmN0aW9uIHByb2Nlc3NDb21wb25lbnRTdHlsZXNoZWV0cygpIHtcbiAgcmV0dXJuIENvbmZpZy5FTkFCTEVfU0NTUyA/XG4gICAgbWVyZ2UoXG4gICAgICBwcm9jZXNzQ29tcG9uZW50U2NzcygpLFxuICAgICAgcHJvY2Vzc0NvbXBvbmVudENzcygpKVxuICAgIDpcbiAgICBwcm9jZXNzQ29tcG9uZW50Q3NzKCk7XG59XG5cbi8qKlxuICogUHJvY2VzcyBzY3NzIGZpbGVzIHJlZmVyZW5jZWQgZnJvbSBBbmd1bGFyIGNvbXBvbmVudCBgc3R5bGVVcmxzYCBtZXRhZGF0YVxuICovXG5mdW5jdGlvbiBwcm9jZXNzQ29tcG9uZW50U2NzcygpIHtcbiAgcmV0dXJuIGdldFNDU1NGaWxlcygncHJvY2Vzcy1jb21wb25lbnQtc2NzcycsIFthcHBTQ1NTRmlsZXNdLCBbYWJzdHJhY3RTQ1NTRmlsZXNdKVxuICAgIC5waXBlKHBsdWdpbnMuc291cmNlbWFwcy5pbml0KCkpXG4gICAgLnBpcGUocGx1Z2lucy5zYXNzKENvbmZpZy5nZXRQbHVnaW5Db25maWcoJ2d1bHAtc2FzcycpKS5vbignZXJyb3InLCBwbHVnaW5zLnNhc3MubG9nRXJyb3IpKVxuICAgIC5waXBlKHBsdWdpbnMucG9zdGNzcyhwcm9jZXNzb3JzKSlcbiAgICAub24oJ2Vycm9yJywgcmVwb3J0UG9zdENzc0Vycm9yKVxuICAgIC5waXBlKHBsdWdpbnMuc291cmNlbWFwcy53cml0ZShpc1Byb2QgPyAnLicgOiAnJywge1xuICAgICAgc291cmNlTWFwcGluZ1VSTDogKGZpbGU6IGFueSkgPT4ge1xuICAgICAgICAvLyB3cml0ZSBhYnNvbHV0ZSB1cmxzIHRvIHRoZSBtYXAgZmlsZXNcbiAgICAgICAgcmV0dXJuIGAke0NvbmZpZy5BUFBfQkFTRX0ke2ZpbGUucmVsYXRpdmV9Lm1hcGA7XG4gICAgICB9XG4gICAgfSkpXG4gICAgLnBpcGUoZ3VscC5kZXN0KGlzUHJvZCA/IENvbmZpZy5UTVBfRElSIDogQ29uZmlnLkFQUF9ERVNUKSk7XG59XG5cbi8qKlxuICsgKiBHZXQgU0NTUyBGaWxlcyB0byBwcm9jZXNzXG4gKyAqL1xuZnVuY3Rpb24gZ2V0U0NTU0ZpbGVzKGNhY2hlTmFtZTpzdHJpbmcsIGZpbGVzVG9Db21waWxlOnN0cmluZ1tdLCBmaWxlc1RvRXhjbHVkZTpzdHJpbmdbXSA9IFtdKSB7XG4gIGxldCBhbGxGaWxlczpzdHJpbmdbXSA9IGZpbGVzVG9Db21waWxlLmNvbmNhdChmaWxlc1RvRXhjbHVkZSk7XG4gIGxldCBmaWx0ZXJlZEZpbGVzOnN0cmluZ1tdID0gZmlsZXNUb0NvbXBpbGUuY29uY2F0KFxuICAgIGZpbGVzVG9FeGNsdWRlLm1hcCgocGF0aDpzdHJpbmcpID0+IHsgcmV0dXJuICchJyArIHBhdGg7IH0pXG4gICk7XG4gIHJldHVybiBndWxwLnNyYyhhbGxGaWxlcylcbiAgICAucGlwZShwbHVnaW5zLmNhY2hlZChjYWNoZU5hbWUpKVxuICAgIC5waXBlKHBsdWdpbnMucHJvZ2VueSgpKVxuICAgIC5waXBlKGZpbHRlcihmaWx0ZXJlZEZpbGVzKSk7XG59XG5cbi8qKlxuICogUHJvY2Vzc2VzIHRoZSBDU1MgZmlsZXMgd2l0aGluIGBzcmMvY2xpZW50YCBleGNsdWRpbmcgdGhvc2UgaW4gYHNyYy9jbGllbnQvYXNzZXRzYCB1c2luZyBgcG9zdGNzc2Agd2l0aCB0aGVcbiAqIGNvbmZpZ3VyZWQgcHJvY2Vzc29ycy5cbiAqL1xuZnVuY3Rpb24gcHJvY2Vzc0NvbXBvbmVudENzcygpIHtcbiAgcmV0dXJuIGd1bHAuc3JjKFtcbiAgICBqb2luKENvbmZpZy5BUFBfU1JDLCAnKionLCAnKi5jc3MnKSxcbiAgICAnIScgKyBqb2luKENvbmZpZy5BUFBfU1JDLCAnYXNzZXRzJywgJyoqJywgJyouY3NzJylcbiAgXSlcbiAgICAucGlwZShpc1Byb2QgPyBwbHVnaW5zLmNhY2hlZCgncHJvY2Vzcy1jb21wb25lbnQtY3NzJykgOiBwbHVnaW5zLnV0aWwubm9vcCgpKVxuICAgIC5waXBlKHBsdWdpbnMucG9zdGNzcyhwcm9jZXNzb3JzKSlcbiAgICAub24oJ2Vycm9yJywgcmVwb3J0UG9zdENzc0Vycm9yKVxuICAgIC5waXBlKGd1bHAuZGVzdChpc1Byb2QgPyBDb25maWcuVE1QX0RJUiA6IENvbmZpZy5BUFBfREVTVCkpO1xufVxuXG4vKipcbiAqIEV4ZWN1dGUgZXh0ZXJuYWwtc3R5bGVzaGVldCBwcm9jZXNzaW5nIG1ldGhvZCBiYXNlZCBvbiBwcmVzZW5jZSBvZiAtLXNjc3MgZmxhZy5cbiAqL1xuZnVuY3Rpb24gcHJvY2Vzc0V4dGVybmFsU3R5bGVzaGVldHMoKSB7XG4gIHJldHVybiBDb25maWcuRU5BQkxFX1NDU1MgPyBwcm9jZXNzQWxsRXh0ZXJuYWxTdHlsZXNoZWV0cygpIDogcHJvY2Vzc0V4dGVybmFsQ3NzKCk7XG59XG5cbi8qKlxuICogUHJvY2VzcyBzY3NzIHN0eWxlc2hlZXRzIGxvY2F0ZWQgaW4gYHNyYy9jbGllbnQvY3NzYCBhbmQgYW55IGNzcyBkZXBlbmRlbmNpZXMgc3BlY2lmaWVkIGluXG4gKiB0aGUgZ2xvYmFsIHByb2plY3QgY29uZmlndXJhdGlvbi5cbiAqL1xuZnVuY3Rpb24gcHJvY2Vzc0FsbEV4dGVybmFsU3R5bGVzaGVldHMoKSB7XG4gIHJldHVybiBtZXJnZShnZXRFeHRlcm5hbENzc1N0cmVhbSgpLCBnZXRFeHRlcm5hbFNjc3NTdHJlYW0oKSlcbiAgICAucGlwZShpc1Byb2QgPyBwbHVnaW5zLmNvbmNhdENzcyhndWxwQ29uY2F0Q3NzQ29uZmlnLnRhcmdldEZpbGUsIGd1bHBDb25jYXRDc3NDb25maWcub3B0aW9ucykgOiBwbHVnaW5zLnV0aWwubm9vcCgpKVxuICAgIC5waXBlKHBsdWdpbnMucG9zdGNzcyhwcm9jZXNzb3JzKSlcbiAgICAub24oJ2Vycm9yJywgcmVwb3J0UG9zdENzc0Vycm9yKVxuICAgIC5waXBlKGd1bHAuZGVzdChDb25maWcuQ1NTX0RFU1QpKTtcbn1cblxuLyoqXG4gKiBHZXQgYSBzdHJlYW0gb2YgZXh0ZXJuYWwgY3NzIGZpbGVzIGZvciBzdWJzZXF1ZW50IHByb2Nlc3NpbmcuXG4gKi9cbmZ1bmN0aW9uIGdldEV4dGVybmFsQ3NzU3RyZWFtKCkge1xuICByZXR1cm4gZ3VscC5zcmMoZ2V0RXh0ZXJuYWxDc3MoKSlcbiAgICAucGlwZShpc1Byb2QgPyBwbHVnaW5zLmNhY2hlZCgncHJvY2Vzcy1leHRlcm5hbC1jc3MnKSA6IHBsdWdpbnMudXRpbC5ub29wKCkpO1xufVxuXG4vKipcbiAqIEdldCBhbiBhcnJheSBvZiBmaWxlbmFtZXMgcmVmZXJyaW5nIHRvIGFsbCBleHRlcm5hbCBjc3Mgc3R5bGVzaGVldHMuXG4gKi9cbmZ1bmN0aW9uIGdldEV4dGVybmFsQ3NzKCkge1xuICByZXR1cm4gQ29uZmlnLkRFUEVOREVOQ0lFUy5maWx0ZXIoZGVwID0+IC9cXC5jc3MkLy50ZXN0KGRlcC5zcmMpKS5tYXAoZGVwID0+IGRlcC5zcmMpO1xufVxuXG4vKipcbiAqIEdldCBhIHN0cmVhbSBvZiBleHRlcm5hbCBzY3NzIGZpbGVzIGZvciBzdWJzZXF1ZW50IHByb2Nlc3NpbmcuXG4gKi9cbmZ1bmN0aW9uIGdldEV4dGVybmFsU2Nzc1N0cmVhbSgpIHtcbiAgcmV0dXJuIGdldFNDU1NGaWxlcygncHJvY2Vzcy1leHRlcm5hbC1zY3NzJywgZ2V0RXh0ZXJuYWxTY3NzKCksIFthYnN0cmFjdFNDU1NGaWxlc10pXG4gICAgLnBpcGUocGx1Z2lucy5zYXNzKENvbmZpZy5nZXRQbHVnaW5Db25maWcoJ2d1bHAtc2FzcycpKS5vbignZXJyb3InLCBwbHVnaW5zLnNhc3MubG9nRXJyb3IpKTtcbn1cblxuLyoqXG4gKiBHZXQgYW4gYXJyYXkgb2YgZmlsZW5hbWVzIHJlZmVycmluZyB0byBleHRlcm5hbCBzY3NzIHN0eWxlc2hlZXRzIGxvY2F0ZWQgaW4gdGhlIGdsb2JhbCBERVBFTkRFTkNJRVNcbiAqIGFzIHdlbGwgYXMgaW4gYHNyYy9jc3NgLlxuICovXG5mdW5jdGlvbiBnZXRFeHRlcm5hbFNjc3MoKSB7XG4gIHJldHVybiBDb25maWcuREVQRU5ERU5DSUVTLmZpbHRlcihkZXAgPT4gL1xcLnNjc3MkLy50ZXN0KGRlcC5zcmMpKS5tYXAoZGVwID0+IGRlcC5zcmMpXG4gICAgLmNvbmNhdChbZW50cnlTQ1NTRmlsZXNdKTtcbn1cblxuLyoqXG4gKiBQcm9jZXNzZXMgdGhlIGV4dGVybmFsIENTUyBmaWxlcyB1c2luZyBgcG9zdGNzc2Agd2l0aCB0aGUgY29uZmlndXJlZCBwcm9jZXNzb3JzLlxuICovXG5mdW5jdGlvbiBwcm9jZXNzRXh0ZXJuYWxDc3MoKSB7XG4gIHJldHVybiBnZXRFeHRlcm5hbENzc1N0cmVhbSgpXG4gICAgLnBpcGUocGx1Z2lucy5wb3N0Y3NzKHByb2Nlc3NvcnMpKVxuICAgIC5waXBlKGlzUHJvZCA/IHBsdWdpbnMuY29uY2F0Q3NzKGd1bHBDb25jYXRDc3NDb25maWcudGFyZ2V0RmlsZSwgZ3VscENvbmNhdENzc0NvbmZpZy5vcHRpb25zKSA6IHBsdWdpbnMudXRpbC5ub29wKCkpXG4gICAgLm9uKCdlcnJvcicsIHJlcG9ydFBvc3RDc3NFcnJvcilcbiAgICAucGlwZShndWxwLmRlc3QoQ29uZmlnLkNTU19ERVNUKSk7XG59XG5cbi8qKlxuICogRXhlY3V0ZXMgdGhlIGJ1aWxkIHByb2Nlc3MsIHByb2Nlc3NpbmcgdGhlIEhUTUwgYW5kIENTUyBmaWxlcy5cbiAqL1xuZXhwb3J0ID1cbiAgY2xhc3MgQnVpbGRIdG1sQ3NzIGV4dGVuZHMgQ3NzVGFzayB7XG5cbiAgICBzaGFsbFJ1bihmaWxlczogU3RyaW5nW10pIHtcbiAgICAgIHJldHVybiBzdXBlci5zaGFsbFJ1bihmaWxlcykgfHwgZmlsZXMuc29tZShmID0+IGYuZW5kc1dpdGgoJy5odG1sJykpO1xuICAgIH1cblxuICAgIHJ1bigpIHtcbiAgICAgIHJldHVybiBtZXJnZShwcm9jZXNzQ29tcG9uZW50U3R5bGVzaGVldHMoKSwgcHJlcGFyZVRlbXBsYXRlcygpLCBwcm9jZXNzRXh0ZXJuYWxTdHlsZXNoZWV0cygpKTtcbiAgICB9XG4gIH07XG4iXX0=